---
layout: post
section-type: post
title: 입문교육 - 1주차
category: tech
tags: [ '자바 집파일 다운로드' ]
---

package com.nhnent.rookie.dabada.mail;

import java.io.BufferedInputStream;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.PrintWriter;
import java.net.URLEncoder;
import java.util.ArrayList;
import java.util.Date;
import java.util.zip.ZipEntry;
import java.util.zip.ZipOutputStream;

import javax.servlet.http.HttpServletResponse;

import org.apache.commons.io.FileUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.PathVariable;

import com.nhnent.rookie.dabada.domain.MailFile;
import com.nhnent.rookie.dabada.mapper.MailFileMapper;
import com.nhnent.rookie.dabada.mapper.MailMapper;

@Service
public class MailFileService {
	@Autowired
	private MailFileMapper mailFileMapper;
	@Autowired
	private MailMapper mailMapper;
	private static final Logger logger = LoggerFactory.getLogger(MailFileService.class);
	
	//첨부파일 다운로드
	public void mailFileDownload(int fileId, Model model, HttpServletResponse response)throws IOException {
		
		MailFile mailFile = mailFileMapper.getMailFile(fileId);
		
		if(checkMailFileDeadline(mailFile)) {		//파일 유효
			fileDownload(mailFile,model,response);
		}else {										//유효기간 지남
			response.setContentType("text/html; charset=UTF-8");
			PrintWriter out=response.getWriter();
			out.println("<script> alert('파일 다운로드 유효기간이 지나 파일을 다운로드 할 수 없습니다.'); </script>");
			out.flush();
			out.close();
			
			logger.info("INFO deadline is over : {}({})",mailFile.getFileName(),mailFile.getFileExpirationYmdt());
			return;
		} 
	}
	
	//전체파일 다운로드
	public void totalMailFilesDownload(@PathVariable int mailId, Model model, HttpServletResponse response)throws IOException {
		final int BUFFER_SIZE = 1024*2;
		
		//첨부파일들 받기
		ArrayList<MailFile> mailFiles = mailFileMapper.getMailFiles(mailId);
		
		//zip파일 생성
		String zipFileName = "Download.zip";
		String zipFilePath = "/home1/irteam/store/"+mailId+"/"+zipFileName;
		//String zipFilePath = "D:\\store\\" + mailId + "\\" + zipFileName;
		try(ZipOutputStream zipOutputStream = new ZipOutputStream(new FileOutputStream(zipFilePath))) {
			zipOutputStream.setLevel(8);
			
			for(MailFile mailfile : mailFiles) {
				if(!checkMailFileDeadline(mailfile)) {continue;}	//유효기간 지난 파일 제외
				
				File file = new File(mailfile.getFilePath()+"/"+mailfile.getFileName());
				try(BufferedInputStream bufferedInputStream = new BufferedInputStream(new FileInputStream(file))){
					ZipEntry zentry = new ZipEntry(file.getName());
					zentry.setTime(file.lastModified());
					zipOutputStream.putNextEntry(zentry);
					byte[] buffer = new byte[BUFFER_SIZE];
					int count = 0;
					while((count = bufferedInputStream.read(buffer, 0, BUFFER_SIZE)) != -1) {
						zipOutputStream.write(buffer,  0, count);
					}
					zipOutputStream.closeEntry();
					//bufferedInputStream.close();
				}catch(IOException e) {
					logger.error("파일 입출력에러 : {}",e.getMessage());
				}
			}
			//zipOutputStream.close();			
		}catch(IOException e) {
			logger.error("파일 입출력에러 : {}",e.getMessage());
		}
		
		//zip파일 전송 후 제거 
        try{
        	File zipFile = new File(zipFilePath);
        	byte fileByte[] = FileUtils.readFileToByteArray(zipFile);
   	     
		    response.setContentType("application/octet-stream");
		    response.setContentLength(fileByte.length);
		    response.setHeader("Content-Disposition", "attachment; fileName=\"" + URLEncoder.encode(zipFile.getName(),"UTF-8")+"\";");
		    response.setHeader("Content-Transfer-Encoding", "binary");
		    response.getOutputStream().write(fileByte);
		     
		    response.getOutputStream().flush();
		    response.getOutputStream().close();
		    
        	zipFile.delete();
        } catch (IOException ioe) {
            logger.error("ERROR : FILE_DOWNLOAD_IOEXCEPTION", ioe);
        }
        
	}
	
	//파일 다운로드
	private void fileDownload(MailFile mailFile, Model model, HttpServletResponse response)throws IOException {
		try {
        	File file = new File("/home1/irteam/store/" + mailFile.getMailId() + "/" + mailFile.getFileName());
        	//File file = new File("D:\\store\\" + mailFile.getMailId() + "\\" + mailFile.getFileName());
        	byte fileByte[] = FileUtils.readFileToByteArray(file);
   	     
		    response.setContentType("application/octet-stream");
		    response.setContentLength(fileByte.length);
		    response.setHeader("Content-Disposition", "attachment; fileName=\"" + URLEncoder.encode(mailFile.getFileName(),"UTF-8")+"\";");
		    response.setHeader("Content-Transfer-Encoding", "binary");
		    response.getOutputStream().write(fileByte);
		     
		    response.getOutputStream().flush();
		    response.getOutputStream().close();
        } catch (IOException ioe) {
            logger.error("ERROR : FILE_DOWNLOAD_IOEXCEPTION", ioe);
        } finally {
            
        }
	}
	
	//파일 유효기간 체크  
	private boolean checkMailFileDeadline(MailFile mailFile) {
		if(mailFile.isBigYn()) {
			long diffTime =  mailFile.getFileExpirationYmdt().getTime() - new Date().getTime();	//유효기간-현재시간
			if(diffTime<=0) {return false;}
		}
		
		return true;
	}
	
	
	
}

차후 수정 
